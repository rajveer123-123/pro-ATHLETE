<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Athlete Tracker Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --bg: #f1f5f9; --red: #ef4444; --green: #22c55e; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: auto; }
        
        .main-card { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 25px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        .athlete-card { background: white; padding: 20px; border-radius: 24px; margin-bottom: 20px; position: relative; border: 1px solid #eef2f6; }
        .del-athlete { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--red); cursor: pointer; font-size: 1.2rem; }
        .athlete-name { font-size: 1.6rem; font-weight: 800; color: var(--dark); margin-bottom: 10px; border-left: 5px solid var(--primary); padding-left: 12px; }

        .pb-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .pb-box { background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .pb-box span { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 700; }
        .pb-box div { font-size: 1rem; color: var(--primary); font-weight: 800; }

        .scroll-container { display: none; overflow-x: auto; white-space: nowrap; padding: 10px 0; scroll-snap-type: x mandatory; gap: 15px; }
        .graph-box { display: inline-block; min-width: 300px; width: 90%; background: white; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-right: 15px; scroll-snap-align: center; vertical-align: top; }
        .drawer-btn { background: var(--dark); color: white; border: none; width: 100%; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: 600; }

        .rev-card { background: var(--dark); color: white; padding: 20px; border-radius: 24px; margin-top: 40px; }
        .rev-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .rev-content { display: none; margin-top: 15px; transition: 0.3s; }
        .stars { color: #fbbf24; font-size: 30px; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h2>üèÖ Performance Hub</h2>
        <input type="text" id="pName" placeholder="Athlete Name">
        <select id="sEvent">
            <option value="">-- Select Event --</option>
            <optgroup label="Sprints"><option>100m</option><option>200m</option><option>400m</option></optgroup>
            <optgroup label="Middle/Long Distance"><option>800m</option><option>1500m</option><option>3000m Steeplechase</option><option>5000m</option><option>10000m</option></optgroup>
            <optgroup label="Hurdles"><option>100m/110m Hurdles</option><option>400m Hurdles</option></optgroup>
            <optgroup label="Relays"><option>4x100m Relay</option><option>4x400m Relay</option></optgroup>
            <optgroup label="Jumps"><option>Long Jump</option><option>High Jump</option><option>Triple Jump</option><option>Pole Vault</option></optgroup>
            <optgroup label="Throws"><option>Shot Put</option><option>Discus Throw</option><option>Javelin Throw</option><option>Hammer Throw</option></optgroup>
            <optgroup label="Combined/Other"><option>Decathlon/Heptathlon</option><option>20km Race Walk</option></optgroup>
        </select>
        <input type="date" id="pDate">
        <input type="number" step="0.01" id="pScore" placeholder="Result (Sec/Meters)">
        <button class="btn-save" onclick="saveData()">SAVE PERFORMANCE</button>
    </div>

    <div id="displayArea"></div>

    <div class="rev-card">
        <div class="rev-header" onclick="toggleReviews()">
            <h3 style="margin:0;">üí¨ Reviews <span id="revCount" style="background:#fbbf24; color:#000; padding:2px 8px; border-radius:10px; font-size:12px;">0</span></h3>
            <span id="revArrow">‚ñº</span>
        </div>
        <div id="revContent" class="rev-content">
            <hr style="border: 0.5px solid #334155; margin-bottom: 15px;">
            <input type="text" id="revUser" placeholder="Your Name">
            <select id="revRole"><option>Coach</option><option>Student</option><option>Viewer</option></select>
            <div class="stars" id="starBox">
                <span onclick="setStar(1)">‚òÜ</span><span onclick="setStar(2)">‚òÜ</span><span onclick="setStar(3)">‚òÜ</span><span onclick="setStar(4)">‚òÜ</span><span onclick="setStar(5)">‚òÜ</span>
            </div>
            <textarea id="revMsg" style="width:100%; border-radius:10px; padding:10px; box-sizing: border-box;" placeholder="Write feedback..."></textarea>
            <button class="btn-save" style="background:#fbbf24; color:#000; margin-top:10px;" onclick="saveReview()">SUBMIT REVIEW</button>
            <div id="reviewList" style="margin-top:20px;"></div>
        </div>
    </div>
</div>

<script>
    // --- Unique User Identity ---
    let userID = localStorage.getItem('athleteTracker_ID');
    if (!userID) {
        userID = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('athleteTracker_ID', userID);
    }

    const firebaseConfig = {
        apiKey: "AIzaSyBXlSIIG2czsrKYMJ07H7ibhXqd7jpOQR0",
        authDomain: "athletetracker-5efd6.firebaseapp.com",
        projectId: "athletetracker-5efd6",
        databaseURL: "https://athletetracker-5efd6-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let chartStorage = {};
    let starRating = 0;

    function toggleReviews() {
        const content = document.getElementById('revContent');
        const arrow = document.getElementById('revArrow');
        content.style.display = (content.style.display === "block") ? "none" : "block";
        arrow.innerText = (content.style.display === "block") ? "‚ñ≤" : "‚ñº";
    }

    function saveData() {
        const n = document.getElementById('pName').value.trim();
        const e = document.getElementById('sEvent').value;
        const d = document.getElementById('pDate').value;
        const s = parseFloat(document.getElementById('pScore').value);
        if(!n || !e || !d || isNaN(s)) return alert("Fill all fields");

        const eKey = e.replace(/[^a-zA-Z0-9]/g, '');
        // Data is now saved under the unique userID
        db.ref(`${userID}/athletes/${n}/${eKey}`).push({ date: d, score: s, eventName: e });
        document.getElementById('pScore').value = '';
    }

    function deleteAthlete(name) { if(confirm(`Delete ${name}?`)) db.ref(`${userID}/athletes/${name}`).remove(); }
    function deleteSport(name, key) { if(confirm("Delete this sport?")) db.ref(`${userID}/athletes/${name}/${key}`).remove(); }

    function toggleScroll(id) {
        const el = document.getElementById(`scroll-${id}`);
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    db.ref(`${userID}/athletes`).on('value', snap => {
        const area = document.getElementById('displayArea');
        area.innerHTML = '';
        Object.values(chartStorage).forEach(c => c.destroy());
        chartStorage = {};

        const data = snap.val();
        if(!data) return;

        for(let athlete in data) {
            const sID = athlete.replace(/\s/g, '');
            const card = document.createElement('div');
            card.className = 'athlete-card';
            card.innerHTML = `
                <button class="del-athlete" onclick="deleteAthlete('${athlete}')">üóëÔ∏è</button>
                <div class="athlete-name">üë§ ${athlete}</div>
                <div class="pb-grid" id="pb-g-${sID}"></div>
                <button class="drawer-btn" onclick="toggleScroll('${sID}')">üìä VIEW ALL GRAPHS</button>
                <div class="scroll-container" id="scroll-${sID}"></div>
            `;
            area.appendChild(card);

            for(let eKey in data[athlete]) {
                const logs = Object.values(data[athlete][eKey]).sort((a,b) => new Date(a.date) - new Date(b.date));
                const scores = logs.map(l => l.score);
                const evName = logs[0].eventName;
                const isTime = /m|Relay|Hurdle/i.test(evName) && !/Jump|Throw|Put/i.test(evName);
                const unit = isTime ? "s" : "m";
                const pb = isTime ? Math.min(...scores) : Math.max(...scores);

                document.getElementById(`pb-g-${sID}`).innerHTML += `<div class="pb-box"><span>${evName}</span><div>${pb}${unit}</div></div>`;

                const canvasId = `c-${sID}-${eKey}`;
                const box = document.createElement('div');
                box.className = 'graph-box';
                box.innerHTML = `<div style="display:flex; justify-content:space-between"><b>${evName}</b> <button onclick="deleteSport('${athlete}','${eKey}')" style="border:none;background:none;cursor:pointer">‚ùå</button></div><canvas id="${canvasId}"></canvas>`;
                document.getElementById(`scroll-${sID}`).appendChild(box);

                const ctx = document.getElementById(canvasId).getContext('2d');
                chartStorage[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: logs.map(l => l.date),
                        datasets: [{
                            data: scores,
                            segment: { borderColor: ctx => {
                                const p1 = ctx.p0.parsed.y; const p2 = ctx.p1.parsed.y;
                                const imp = isTime ? p2 < p1 : p2 > p1;
                                return imp ? '#22c55e' : '#ef4444';
                            }},
                            borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff'
                        }]
                    },
                    options: { scales: { y: { reverse: isTime, ticks: { callback: v => v + unit } } }, plugins: { legend: { display: false } } }
                });
            }
        }
    });

    function setStar(n) { starRating = n; const s = document.getElementById('starBox').children; for(let i=0;i<5;i++) s[i].innerText = i<n?'‚òÖ':'‚òÜ'; }
    function saveReview() {
        const u = document.getElementById('revUser').value; const r = document.getElementById('revRole').value; const m = document.getElementById('revMsg').value;
        if(!u || !m || starRating === 0) return alert("Complete review!");
        db.ref('reviews').push({ user: u, role: r, msg: m, stars: starRating });
        document.getElementById('revMsg').value = ''; setStar(0);
    }
    db.ref('reviews').on('value', snap => {
        const list = document.getElementById('reviewList'); list.innerHTML = '';
        const data = snap.val(); if(!data) return;
        document.getElementById('revCount').innerText = Object.keys(data).length;
        Object.values(data).reverse().forEach(r => {
            list.innerHTML += `<div style="background:#1e293b; padding:10px; border-radius:10px; margin-bottom:10px; border-left:3px solid #fbbf24">
                <b>${r.user} (${r.role})</b> <span style="color:#fbbf24">${"‚òÖ".repeat(r.stars)}</span><br><small>${r.msg}</small></div>`;
        });
    });
</script>
</body>
</html>
