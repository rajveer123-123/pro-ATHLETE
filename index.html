// --- YOUR FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyBXlSIIG2czsrKYMJ07H7ibhXqd7jpOQR0",
    authDomain: "athletetracker-5efd6.firebaseapp.com",
    projectId: "athletetracker-5efd6",
    storageBucket: "athletetracker-5efd6.firebasestorage.app",
    messagingSenderId: "79516207784",
    appId: "1:79516207784:web:30fa59ccbf9e9a5eeb109d",
    measurementId: "G-YLH1Y2MKKF",
    databaseURL: "https://athletetracker-5efd6-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 1. Direct Save (No Alerts)
function saveData() {
    const name = document.getElementById('pName').value.trim();
    const sport = document.getElementById('sName').value;
    const date = document.getElementById('pDate').value;
    const score = parseFloat(document.getElementById('pScore').value);
    
    if(!name || !date || isNaN(score)) return alert("Details bharo!");

    // alert() hata diya gaya hai taaki direct save ho
    database.ref('athletes/' + name + '/' + sport.replace(/\s/g, '')).push({
        date: date,
        score: score
    });
    
    // Input field clear kar dena taaki pata chale save ho gaya
    document.getElementById('pScore').value = '';
}

// 2. Delete Functionality
function deleteSportRecord(playerName, sportKey) {
    if(confirm(`${playerName} ka ${sportKey} data delete karein?`)) {
        database.ref('athletes/' + playerName + '/' + sportKey).remove();
    }
}

database.ref('athletes').on('value', (snapshot) => {
    const data = snapshot.val();
    renderAthletes(data);
});

function renderAthletes(db) {
    const area = document.getElementById('displayArea');
    area.innerHTML = '';
    if(!db) return;

    for (let player in db) {
        const card = document.createElement('div');
        card.className = 'player-card';
        let html = `<h2>ğŸ‘¤ ${player}</h2>`;

        for (let sportKey in db[player]) {
            const records = Object.values(db[player][sportKey]).sort((a,b) => new Date(a.date) - new Date(b.date));
            const scores = records.map(r => r.score);
            
            const isTimeEvent = sportKey.toLowerCase().includes("sprint") || 
                              sportKey.toLowerCase().includes("run") || 
                              sportKey.toLowerCase().includes("hurdles");
            
            const pb = isTimeEvent ? Math.min(...scores) : Math.max(...scores);
            const unit = isTimeEvent ? "s" : "m";

            html += `
                <div style="margin-top:20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>ğŸ”¥ ${sportKey}</strong>
                        <div>
                            <span class="pb-badge">ğŸ† PB: ${pb}${unit}</span>
                            <button onclick="deleteSportRecord('${player}', '${sportKey}')" 
                                    style="background:none; border:none; color:red; cursor:pointer; font-size:18px; margin-left:10px;">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    <canvas id="chart-${player.replace(/\s/g, '')}-${sportKey}"></canvas>
                </div>
            `;
        }
        card.innerHTML = html;
        area.appendChild(card);

        // Render Charts
        for (let sportKey in db[player]) {
            const records = Object.values(db[player][sportKey]).sort((a,b) => new Date(a.date) - new Date(b.date));
            const canvasId = `chart-${player.replace(/\s/g, '')}-${sportKey}`;
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: records.map(r => r.date),
                    datasets: [{ 
                        label: 'Performance', 
                        data: records.map(r => r.score), 
                        borderColor: '#2563eb', 
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3 
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
    }
}
